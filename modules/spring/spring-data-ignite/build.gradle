/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements. See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

apply from: "$rootDir/buildscripts/java-core.gradle"
apply from: "$rootDir/buildscripts/publishing.gradle"
apply from: "$rootDir/buildscripts/java-junit5.gradle"

description = "spring-data-ignite"

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

dependencies {
    implementation project(':ignite-client')
    implementation project(":ignite-jdbc")
    implementation libs.spring.boot
    implementation libs.spring.boot.autoconfigure
    implementation libs.spring.data.jdbc

    testImplementation libs.spring.boot.test
    testImplementation libs.assertj.core
    testImplementation testFixtures(project(':ignite-runner'))
    testImplementation testFixtures(project(':ignite-core'))
}

// ========================================
// Spring Data 4.0 Testing Support
// ========================================

// Create isolated configuration for Spring Data 4.0 testing
configurations {
    springData4Implementation {
        canBeResolved = true
        canBeConsumed = false
    }
    springData4RuntimeClasspath {
        extendsFrom springData4Implementation
        canBeResolved = true
        canBeConsumed = false
    }
}

configurations.springData4RuntimeClasspath {
    resolutionStrategy.eachDependency { DependencyResolveDetails details ->
        if (details.requested.module.group == 'org.springframework.boot' ||
            details.requested.module.group == 'org.springframework.data') {
            if (details.requested.module.toString().contains('spring-boot')) {
                details.useVersion '4.0.2'
                details.because 'Testing against Spring Boot 4.0.2'
            } else if (details.requested.module.toString().contains('spring-data')) {
                details.useVersion '4.0.2'
                details.because 'Testing against Spring Data 4.0.2'
            }
        }
    }
}

// Spring Data 4.0 dependencies - completely separate from default
dependencies {
    springData4Implementation project(':ignite-client')
    springData4Implementation project(":ignite-jdbc")

    // Spring Boot 4.0.2 with Spring Data 4.0.2
    springData4Implementation platform("org.springframework.boot:spring-boot-dependencies:4.0.2")
    springData4Implementation 'org.springframework.boot:spring-boot'
    springData4Implementation 'org.springframework.boot:spring-boot-autoconfigure'
    springData4Implementation('org.springframework.boot:spring-boot-starter-data-jdbc') {
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
        exclude group: 'ch.qos.logback', module: 'logback-classic'
    }
    springData4Implementation libs.bundles.junit6
    springData4Implementation libs.assertj.core
    springData4Implementation libs.bundles.log4j
    springData4Implementation 'org.springframework.boot:spring-boot-test'
    springData4Implementation testFixtures(project(':ignite-runner'))
    springData4Implementation testFixtures(project(':ignite-core'))
}

// Test task for Spring Data 4.0
tasks.register('testSpringData4', Test) {
    description = 'Runs tests against Spring Data 4.0.2 (Spring Boot 4.0.2) with JUnit 6'
    group = 'verification'

    testClassesDirs = sourceSets.test.output.classesDirs
    classpath = configurations.springData4Implementation + sourceSets.main.output + sourceSets.test.output

    systemProperty 'spring.data.version', '4.0.2'
    useJUnitPlatform()

    // Add version info to test output
    testLogging {
        events "passed", "skipped", "failed"
        displayGranularity 2
    }
}

// Default test task uses Spring Data 3.5
tasks.named('test') {
    systemProperty 'spring.data.version', '3.5.5'

    // Add version info to test output
    testLogging {
        events "passed", "skipped", "failed"
        displayGranularity 2
    }

    finalizedBy testSpringData4
}
