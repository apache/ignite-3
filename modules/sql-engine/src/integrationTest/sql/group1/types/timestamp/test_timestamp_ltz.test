# name: test/sql/types/timestamp/test_timestamp_ltz.test
# description: Test TIMESTAMP WITH LOCAL TIME ZONE type
# group: [timestamp]

statement ok
PRAGMA enable_verification

statement ok
PRAGMA time_zone=Europe/Paris

query T
SELECT TIMESTAMP WITH LOCAL TIME ZONE '2017-07-23 13:10:11'::VARCHAR
----
2017-07-23 13:10:11 Europe/Paris

query T
SELECT TIMESTAMP WITH LOCAL TIME ZONE '2017-07-23 13:10:11'
----
2017-07-23T11:10:11Z

statement error: Illegal TIMESTAMP WITH LOCAL TIME ZONE literal
SELECT TIMESTAMP WITH LOCAL TIME ZONE '    2017-07-23     13:10:11    ';

# other trailing, preceding, or middle gunk is not accepted
statement error: Illegal TIMESTAMP WITH LOCAL TIME ZONE literal
SELECT TIMESTAMP WITH LOCAL TIME ZONE '    2017-07-23     13:10:11    AA';

query I
SELECT YEAR(TIMESTAMP WITH LOCAL TIME ZONE '1992-01-01 01:01:01');
----
1992

query I
SELECT YEAR(TIMESTAMP WITH LOCAL TIME ZONE '1992-01-01 01:01:01'::DATE);
----
1992

query T
SELECT (TIMESTAMP WITH LOCAL TIME ZONE '1992-01-01 01:01:01')::DATE;
----
1992-01-01

query T
SELECT (TIMESTAMP WITH LOCAL TIME ZONE '1992-01-01 01:01:01')::TIME;
----
01:01:01

query T
SELECT (DATE '1992-01-01')::TIMESTAMP WITH LOCAL TIME ZONE::VARCHAR;
----
1992-01-01 00:00:00.000000 Europe/Paris

query T
SELECT TIMESTAMP WITH LOCAL TIME ZONE '2008-01-01 00:00:01.5'
----
2007-12-31T23:00:01.500Z

query T
SELECT TIMESTAMP WITH LOCAL TIME ZONE '2008-01-01 00:00:01.5'::VARCHAR
----
2008-01-01 00:00:01.5 Europe/Paris

query T
SELECT TIMESTAMP WITH LOCAL TIME ZONE '2008-01-01 00:00:01.999'
----
2007-12-31T23:00:01.999Z

query T
SELECT TIMESTAMP WITH LOCAL TIME ZONE '2008-01-01 00:00:01.999'::VARCHAR
----
2008-01-01 00:00:01.999 Europe/Paris

# timestamp with large date
statement error: Timestamp literal 'TIMESTAMP WITH LOCAL TIME ZONE '100000-01-01 00:00:01.5'' out of range.
SELECT TIMESTAMP WITH LOCAL TIME ZONE '100000-01-01 00:00:01.5'

statement error: Illegal TIMESTAMP WITH LOCAL TIME ZONE literal '9223372036854775808-01-01 00:00:01.5': not in format 'yyyy-MM-dd HH:mm:ss'
SELECT TIMESTAMP WITH LOCAL TIME ZONE '9223372036854775808-01-01 00:00:01.5'

query T
SELECT '2008-01-01 00:00:01.999'::TIMESTAMP WITH LOCAL TIME ZONE::VARCHAR
----
2008-01-01 00:00:01.999000 Europe/Paris

# Value must be truncated.
query T
SELECT '2008-01-01 00:00:01.969'::TIMESTAMP(2) WITH LOCAL TIME ZONE::VARCHAR
----
2008-01-01 00:00:01.96 Europe/Paris

query T
SELECT '2008-01-01 00:00:01.9995'::TIMESTAMP(3) WITH LOCAL TIME ZONE::VARCHAR
----
2008-01-01 00:00:01.999 Europe/Paris

# Value must be rounded down.
query T
SELECT '2008-01-01 00:00:01.9994'::TIMESTAMP(3) WITH LOCAL TIME ZONE::VARCHAR
----
2008-01-01 00:00:01.999 Europe/Paris

#############

statement ok
CREATE TABLE IF NOT EXISTS timestamp_ltz_t (t TIMESTAMP WITH LOCAL TIME ZONE);

statement ok
PRAGMA time_zone=Europe/Paris

statement ok
INSERT INTO timestamp_ltz_t VALUES (TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 18:40:00')

query T
SELECT t::VARCHAR FROM timestamp_ltz_t ORDER BY t;
----
2008-04-03 18:40:00.000000 Europe/Paris

# Change time zone (UTC -4)
statement ok
PRAGMA time_zone=America/New_York

query T
SELECT t::VARCHAR FROM timestamp_ltz_t ORDER BY t;
----
2008-04-03 12:40:00.000000 America/New_York

# Revert time zone change
statement ok
PRAGMA time_zone=Europe/Paris

statement ok
DROP TABLE timestamp_ltz_t

# Literals

statement ok
CREATE TABLE timestamp_ltz_t(id INT PRIMARY KEY, t1_0 TIMESTAMP(0) WITH LOCAL TIME ZONE, t1_1 TIMESTAMP(1) WITH LOCAL TIME ZONE, t1_2 TIMESTAMP(2) WITH LOCAL TIME ZONE, t1_3 TIMESTAMP(3) WITH LOCAL TIME ZONE)

statement ok
INSERT INTO timestamp_ltz_t VALUES(1, TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.333')

statement ok
INSERT INTO timestamp_ltz_t VALUES(2, TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.999')

statement ok
INSERT INTO timestamp_ltz_t VALUES(3, TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.333')

statement ok
INSERT INTO timestamp_ltz_t VALUES(4, TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.999')

query TTTT
SELECT t1_0::VARCHAR, t1_1::VARCHAR, t1_2::VARCHAR, t1_3::VARCHAR FROM timestamp_ltz_t ORDER BY id ASC
----
2008-04-03 00:00:00 Europe/Paris	2008-04-03 00:00:00.3 Europe/Paris	2008-04-03 00:00:00.33 Europe/Paris	2008-04-03 00:00:00.333 Europe/Paris
2008-04-03 00:00:00 Europe/Paris	2008-04-03 00:00:00.9 Europe/Paris	2008-04-03 00:00:00.99 Europe/Paris	2008-04-03 00:00:00.999 Europe/Paris
2008-04-03 00:00:59 Europe/Paris	2008-04-03 00:00:59.3 Europe/Paris	2008-04-03 00:00:59.33 Europe/Paris	2008-04-03 00:00:59.333 Europe/Paris
2008-04-03 00:00:59 Europe/Paris	2008-04-03 00:00:59.9 Europe/Paris	2008-04-03 00:00:59.99 Europe/Paris	2008-04-03 00:00:59.999 Europe/Paris

statement ok
DROP TABLE timestamp_ltz_t

# Cast to time instead of literals

statement ok
CREATE TABLE timestamp_ltz_t(id INT PRIMARY KEY, t1_0 TIMESTAMP(0) WITH LOCAL TIME ZONE, t1_1 TIMESTAMP(1) WITH LOCAL TIME ZONE, t1_2 TIMESTAMP(2) WITH LOCAL TIME ZONE, t1_3 TIMESTAMP(3) WITH LOCAL TIME ZONE)

statement ok
INSERT INTO timestamp_ltz_t VALUES(1, '2008-04-03 00:00:00.333'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:00.333'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:00.333'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:00.333'::TIMESTAMP WITH LOCAL TIME ZONE)

statement ok
INSERT INTO timestamp_ltz_t VALUES(2, '2008-04-03 00:00:00.999'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:00.999'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:00.999'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:00.999'::TIMESTAMP WITH LOCAL TIME ZONE)

statement ok
INSERT INTO timestamp_ltz_t VALUES(3, '2008-04-03 00:00:59.333'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:59.333'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:59.333'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:59.333'::TIMESTAMP WITH LOCAL TIME ZONE)

statement ok
INSERT INTO timestamp_ltz_t VALUES(4, '2008-04-03 00:00:59.999'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:59.999'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:59.999'::TIMESTAMP WITH LOCAL TIME ZONE, '2008-04-03 00:00:59.999'::TIMESTAMP WITH LOCAL TIME ZONE)

# https://issues.apache.org/jira/browse/IGNITE-20651 Timestamp with local time zone. Insert with cast operation ignores target precision
skipif ignite3
query TTTT
SELECT t1_0::VARCHAR, t1_1::VARCHAR, t1_2::VARCHAR, t1_3::VARCHAR FROM timestamp_ltz_t ORDER BY id ASC
----
2008-04-03 00:00:00 Europe/Paris	2008-04-03 00:00:00.3 Europe/Paris	2008-04-03 00:00:00.3 Europe/Paris	2008-04-03 00:00:00.333 Europe/Paris
2008-04-03 00:00:00 Europe/Paris	2008-04-03 00:00:00.9 Europe/Paris	2008-04-03 00:00:00.99 Europe/Paris	2008-04-03 00:00:00.999 Europe/Paris
2008-04-03 00:00:59 Europe/Paris	2008-04-03 00:00:59.3 Europe/Paris	2008-04-03 00:00:59.33 Europe/Paris	2008-04-03 00:00:59.333 Europe/Paris
2008-04-03 00:00:59 Europe/Paris	2008-04-03 00:00:59.9 Europe/Paris	2008-04-03 00:00:59.99 Europe/Paris	2008-04-03 00:00:59.999 Europe/Paris

statement ok
DROP TABLE timestamp_ltz_t

# Sub-millisecond precision time

# Literals

for type in [TIMESTAMP(6) WITH LOCAL TIME ZONE, TIMESTAMP(7) WITH LOCAL TIME ZONE, TIMESTAMP(8) WITH LOCAL TIME ZONE, TIMESTAMP(9) WITH LOCAL TIME ZONE]

statement ok
CREATE TABLE timestamp_ltz_sub_ms(id INT PRIMARY KEY, t1_0 TIMESTAMP(6) WITH LOCAL TIME ZONE, t1_1 TIMESTAMP(7) WITH LOCAL TIME ZONE, t1_2 TIMESTAMP(8)  WITH LOCAL TIME ZONE, t1_3 TIMESTAMP(9)  WITH LOCAL TIME ZONE)

statement ok
INSERT INTO timestamp_ltz_sub_ms VALUES(1, TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.333333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.333333',  TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.333333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.333333')

statement ok
INSERT INTO timestamp_ltz_sub_ms VALUES(2, TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.999999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.999999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.999999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:00.999999')

statement ok
INSERT INTO timestamp_ltz_sub_ms VALUES(3, TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.333333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.333333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.333', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:59.333333')

statement ok
INSERT INTO timestamp_ltz_sub_ms VALUES(4, TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:58.999999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:58.999999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:58.999999', TIMESTAMP WITH LOCAL TIME ZONE '2008-04-03 00:00:58.999999')

query TTTT
SELECT t1_0::VARCHAR, t1_1::VARCHAR, t1_2::VARCHAR, t1_3::VARCHAR FROM timestamp_ltz_sub_ms ORDER BY id ASC
----
2008-04-03 00:00:00.333000 Europe/Paris	2008-04-03 00:00:00.3330000 Europe/Paris	2008-04-03 00:00:00.33300000 Europe/Paris	2008-04-03 00:00:00.333000000 Europe/Paris
2008-04-03 00:00:00.999000 Europe/Paris	2008-04-03 00:00:00.9990000 Europe/Paris	2008-04-03 00:00:00.99900000 Europe/Paris	2008-04-03 00:00:00.999000000 Europe/Paris
2008-04-03 00:00:59.333000 Europe/Paris	2008-04-03 00:00:59.3330000 Europe/Paris	2008-04-03 00:00:59.33300000 Europe/Paris	2008-04-03 00:00:59.333000000 Europe/Paris
2008-04-03 00:00:58.999000 Europe/Paris	2008-04-03 00:00:58.9990000 Europe/Paris	2008-04-03 00:00:58.99900000 Europe/Paris	2008-04-03 00:00:58.999000000 Europe/Paris

statement ok
DROP TABLE timestamp_ltz_sub_ms

endfor

# Cast to time instead of literals

for type in [TIMESTAMP(6) WITH LOCAL TIME ZONE, TIMESTAMP(7) WITH LOCAL TIME ZONE, TIMESTAMP(8) WITH LOCAL TIME ZONE, TIMESTAMP(9) WITH LOCAL TIME ZONE]

statement ok
CREATE TABLE timestamp_ltz_sub_ms(id INT PRIMARY KEY, t1_0 TIMESTAMP(6) WITH LOCAL TIME ZONE, t1_1 TIMESTAMP(7)  WITH LOCAL TIME ZONE, t1_2 TIMESTAMP(8)  WITH LOCAL TIME ZONE, t1_3 TIMESTAMP(9)  WITH LOCAL TIME ZONE)

statement ok
INSERT INTO timestamp_ltz_sub_ms VALUES(1, '2008-04-03 00:00:00.333333'::${type}, '2008-04-03 00:00:00.333333'::${type}, '2008-04-03 00:00:00.333333'::${type}, '2008-04-03 00:00:00.333333'::${type})

statement ok
INSERT INTO timestamp_ltz_sub_ms VALUES(2, '2008-04-03 00:00:00.999999'::${type}, '2008-04-03 00:00:00.999999'::${type}, '2008-04-03 00:00:00.999999'::${type}, '2008-04-03 00:00:00.999999'::${type})

statement ok
INSERT INTO timestamp_ltz_sub_ms VALUES(3, '2008-04-03 00:00:59.333333'::${type}, '2008-04-03 00:00:59.333333'::${type}, '2008-04-03 00:00:59.333333'::${type}, '2008-04-03 00:00:59.333333'::${type})

statement ok
INSERT INTO timestamp_ltz_sub_ms VALUES(4, '2008-04-03 00:00:58.999999'::${type}, '2008-04-03 00:00:58.999999'::${type}, '2008-04-03 00:00:58.999999'::${type}, '2008-04-03 00:00:58.999999'::${type})

statement ok
INSERT INTO timestamp_ltz_sub_ms VALUES(5, '2008-04-03 00:00:00.9999999'::${type}, '2008-04-03 00:00:00.9999999'::${type}, '2008-04-03 00:00:00.9999999'::${type}, '2008-04-03 00:00:00.9999999'::${type})

statement ok
INSERT INTO timestamp_ltz_sub_ms VALUES(6, '2008-04-03 00:00:00.999999999'::${type}, '2008-04-03 00:00:00.999999999'::${type}, '2008-04-03 00:00:00.999999999'::${type}, '2008-04-03 00:00:00.999999999'::${type})

query TTTT
SELECT t1_0::VARCHAR, t1_1::VARCHAR, t1_2::VARCHAR, t1_3::VARCHAR FROM timestamp_ltz_sub_ms ORDER BY id ASC
----
2008-04-03 00:00:00.333000 Europe/Paris	2008-04-03 00:00:00.3330000 Europe/Paris	2008-04-03 00:00:00.33300000 Europe/Paris	2008-04-03 00:00:00.333000000 Europe/Paris
2008-04-03 00:00:00.999000 Europe/Paris	2008-04-03 00:00:00.9990000 Europe/Paris	2008-04-03 00:00:00.99900000 Europe/Paris	2008-04-03 00:00:00.999000000 Europe/Paris
2008-04-03 00:00:59.333000 Europe/Paris	2008-04-03 00:00:59.3330000 Europe/Paris	2008-04-03 00:00:59.33300000 Europe/Paris	2008-04-03 00:00:59.333000000 Europe/Paris
2008-04-03 00:00:58.999000 Europe/Paris	2008-04-03 00:00:58.9990000 Europe/Paris	2008-04-03 00:00:58.99900000 Europe/Paris	2008-04-03 00:00:58.999000000 Europe/Paris
2008-04-03 00:00:00.999000 Europe/Paris	2008-04-03 00:00:00.9990000 Europe/Paris	2008-04-03 00:00:00.99900000 Europe/Paris	2008-04-03 00:00:00.999000000 Europe/Paris
2008-04-03 00:00:00.999000 Europe/Paris	2008-04-03 00:00:00.9990000 Europe/Paris	2008-04-03 00:00:00.99900000 Europe/Paris	2008-04-03 00:00:00.999000000 Europe/Paris

statement ok
DROP TABLE timestamp_ltz_sub_ms

endfor

